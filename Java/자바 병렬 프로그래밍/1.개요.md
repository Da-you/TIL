개요
===
>자바는 스레드로 인해 복잡한 비동기 코드를 단순한 순차적 코드로 변경해 복잡한 시스템을 단순하게 개발할 수 있게 해준다.
> 스레드는 멀티프로세서 시스템의 능력을 활용할 수 있는 가장 쉬운 방법이다.

## 1.1 작업을 동시에 실행하는 일에 대한 간략한 역사
운영체제가 없던 시절의 컴퓨터는 하나의 프로그램을 실행하며 컴퓨터 내 모든 자원은 프로그램이 직접 접근함
- 운영체제 없이 하드웨어 위에서 바로 실행되는 프로그램은 작성이 힘들며, 컴퓨터 자원 사용 대비 성능이 비효율적

운영체제는 여러 개의 프로그램을 각자의 프로세스 내에서 동시 실행할 수 있도록 발전함.
- 운영체제는 프로세스마다 메모리, 파일 핸들, 보안 권한 등의 자원을 할당
- 소켓, 시그널 핸들러, 공유 메모리, 세마포어, 파일 등을 통해 프로세스끼리 통신이 가능

운영체제가 여러 프로그램을 동시에 실행할 수 있게 발전하게된 몇가지 요인이 존재
1. 자원 활용: 하나의 프로그램이 기다리는 동안 다른 프로그램을 실행하도록 지원하는 편이 더 효율적
2. 공정성: 한 번에 프로그램 하나를 끝까지 실행해 종료된 이후에 다른 프로그램을 실행하는 것보다는 더 작은 단위로 컴퓨터를 공유하는 방법이 효율적
3. 편의성: 여러 작업을 처리하는 한 개의 프로그램 보다 하나씩 처리하며 필요시 프로그램간에 조율하는 프로그램 여러 개 작성하는게 쉽고 바람직

자원 활용, 공정성, 편의성 등 프로세스 개념이 만들어진 이유로 스레드라는 개념이 탄생
- 스레드로 인해 한 프로세스 안에 여러 개의 프로그램 제어 흐름이 공존
- 스레드는 메모리, 파일 핸들과 같이 프로세스에 할당된 자원을 공유
- 각 스레드는 별도의 프로그램 카운터, 스택, 지역 변수를 가짐
- 스레드로 인해 한 프로그램 내 여러 스레드를 동시에 여러 개의 CPU에 할당해 실행 가능

스레드는 가벼운 프로세스로 불리며 현대 운영체제는 대부분 프로세스가 아닌 스레드를 기본 단위로 CPU 자원의 스케줄을 정함
의도적인 조율이 없는 한 하나의 스레드는 다른 스레드와 상관 없이 비동기적으로 실행
- 스레드는 자신이 포함된 프로세스 메모리 주소 공간을 공유하기에 한 프로세스 내 모든 스레드는 같은 변수에 접근하고 같은 힙에 객체를 할당하며 데이터를 공유
- 공유된 데이터에 접근하는 과정을 적절하게 동기화하지 않으면 다른 스레드가 사용 중인 변수를 순간적으로 수정해 예상치 못한 결과가 발생할 수 있음

## 1.2 스레드의 이점
- 스레드를 활용으로 개발 및 유지 보수 비용을 줄임
- 복잡한 애플리케이션 성능을 향상시킬 수 있음
- 비동기적인 작업 흐름을 거의 순차적으로 바꿔 사람이 일하고 상호 작용하는 방식을 모델링이 편함
- 서버 애플리케이션의 자원 활용도와 처리율을 높이는 데 유용
- JVM 구현을 단순하게 하도록 도와줌(가비지 컬렉터는 보통 하나 이상의 전용 스레드에서 실행)

멀티 프로세서 활용
> 기술의 발전으로 이미 많은 프로세서를 탑재한 컴퓨터가 등장

- 프로세서 스케줄링의 기본 단위는 스레드이기 때문에 스레드 하나로 동작하는 프로그램은 한 번에 최대 하나의 프로세서만 사용
- 활성 상태의 스레드가 여러 개인 프로그램은 어러 프로세서에서 동시에 실행 가능
  - 제대로 설계한다면 멀티스레드 프로그램은 가용한 프로세서 자원을 더 효율적으로 이용해 처리 속도를 높일 수 있음.
- 멀티 스레드를 사용하면 하나의 프로세서에서도 처리 속도를 높일 수 있음
  - I/O 때문에 대기 상태인 동안에도 다른 스레드는 동작할 수 있어 애플리케이션 실행이 지속됨.

단순한 모델링

- 한 종류 일을 순차적으로 처리하는 프로그램은 작성도 쉽고 오류도 잘 생기지 않음
- 종류별 작업마다 스레드를 하나씩 할당해 마치 순차적인 작업처럼 처리 가능
- 스케줄링, 교차 실행되는 작업, 비동기 I/O, 자원 대기 등의 세부적인 부분과 상위 비즈니스 로직과 분리 가능

즉, 복잡하면서 비동기적인 작업 흐름을 별도의 스레드에서 수행되는 단순하며 동기적인 작업 흐름으로 나눌 수 있음
- 주로 서블릿(Servlet) 이나 RMI(Remote Method Invocation)같은 프레임워크에서 종종 사용
- 프레임워크는 요청 관리, 스레드 생성, 로드 밸런싱, 요청 분배 등을 처리
> 예를 들어, 서블릿 개발자는 동시에 다른 요청이 얼마나 처리되는지에 대해 걱정할 필요가 없다.
> 웹 요청이 들어와 서블릿의 service 메서드가 호출될 때 해당 요청을 마치 단일 스레드 프로그램인 것처럼 처리 가능

단순한 비동기 이벤트 처리
- 여러 클라이언트 프로그램에서 소켓 연결을 받는 서버 애플리케이션은 각 연결 마다 스레드를 할당해 동기 I/O를 사용하면 개발 작업이 쉬워짐

예전에는 단일 스레드 환경에서 읽을 데이터가 없을 때 소켓에서 읽으려고 하면 애플리케이션은 추가 데이터가 들어올 때까지 read 연산에서 대기에 들어가 애플리케이션이 멈추는 상황이 발생해 복잡한 넌블로킹 I/O 기능을 써야했지만, 운영체제에에서 더 만은 스레드를 지원할 수 있게 되어 개선.

빠르게 반응하는 사용자 인터페이스

## 1.3 스레드 사용의 위험성
자바 자체에 스레드 관련 기능이 내장되어 병렬 프로그램 개발이 쉬워졌지만, 스레드를 사용해 작성하는 프로그램이 많아져 스레드 안전성에 대해 잘 알아야 함.

안전성 위해 요소
- 멀티스레드의 연산 순서는 동기화를 충분히 하지 않으면 예측이 어려움
```java
@NotThreadSafe
public class UnsafeSequence {
	private int value;

	/** 유일한 값 리턴 */
	public int getNext() {
		return value++;
	}
}
```
- 위 코드는 스레드 안전하지 않은 일련번호 생성 프로그램
- 두 개의 스레드가 getNext()메서들 동시에 호출 시 같은 값을 얻을 가능성이 존재
- 여러 스레드에서 실행되는 연산은 서로 간에 무작위로 끼어들 가능성이 존재
- 스레드는 서로 같은 메모리 주소 공간을 공유하고 동시에 실행되므로 다른 스레드가 사용중인 변수를 읽거나 변경이 가능
  - 즉, 경쟁 조건이 발생할 수 있음
- 경쟁 조건으로 순차적이던 프로그래밍 모델에 비순차적인 요소가 들어가 동작 과정 추론이 어려워짐
- 멀티스레드 프로그램의 동작을 예측하려면 공유 변수에 대한 적절한 동기화가 필요
- 자바에서는 synchronized라는 동기화 수단을 제공

```java
@ThreadSafe
public class Sequence {
	@GuardedBy("this") private int value;

	/** 유일한 값 리턴 */
	public synchronized int getNext() {
		return value++;
	}
}
```
동기화가 없다면 컴파일러, 하드웨어, 실행 환경 각각에 명령어의 실행 시점, 실행 순서 등을 자유롭게 조정가능하나 개발자 입장에서는 스레드간에 데이터가 공유도고 있는지를 명확하게 구분해 줘야 하는 부담이 생김

활동성 위험
> 활동성이란 "원하는 일이 결국 일어난다"라는 뜻
- 동시 수행 코드 개발할 떄는 스레드 안전성에 신경 써야함.
- 프로그램 작성시 단일,멀티 안전성과 정확성을 유지하도록 작성돼야 함
- 대부분의 병렬 프로그램에서 발생하는 오류는 초기에 파악이 어려우며, 개발이나 테스트 도중에 잘 드러나지 않음.

성능 위험
> 성능 문제는 느린 서비스 시간, 반응성, 처리율, 자원 소모, 확장성 등 넓은 범위위 문제를 포괄
- 멀티스레드 프로그램은 단인 스레드 프로그램에서 발생할 수 있는 모든 성능 위험 이외에도 스레드로 인한 추가 위험에도 노출
  - 스레드가 많은 프로그램에서는 컨텍스트 스위칭이 더 빈번해 부담이 생김.
  - 스레드가 데이터 공유할 때는 동기화 수단도 필요, 이러한 동기화는 컴파일러 최적화를 방해하며, 메모리 캐시를 지우거나 무효화하기도 함
- 공유 메모리 버스에 동기화 관련 트래픽 유발

스레드는 어디에나
스레드는 직접 생성하지 않아도 프레임워크에서 스레드를 생성할 수도 있는데, 이러한 스레드에서 호출되는 코드는 스레드에 안전해야 함.
모든 자바 프로그램은 기본적으로 스레드를 사용하며, JVM을 시작하면 main 메서드를 실행하는 주 스레드와 GC, 객체 종료와 같은 JVM 내부 작업을 담당하는 스레드도 생성한다.
- Timer
- 서블릿과 JSP
- RMI(원격 메서드 호출)
- 스윙과 AWT

정리
===
- 기술의 발전으로 운영체제는 여러 프로그램을 동시에 실행 가능하게 발전
- 자바는 기본적으로 스레드를 사용하여 복잡한 비동기 코드를 순차적인 흐름처럼 쉽게 개발 가능
- 스레드 사용으로 유지 보수 및 비용 절감, 멀티 프로세서 활용으로 성능 향상, 쉬운 모델링 등의 이점이 존재
- 스레드는 직접 생성하지 않아도 사용하는 프레임워크에서 생성하는 경우도 존재
- 개발자는 경쟁 조건, 데드락, 기아 상태, 컨텍스트 스위칭에 대한 위험성을 인지하고 적절한 동기화와 설계 방법에 대해 알아야 한다.
